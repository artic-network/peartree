<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PearTree — Phylogenetic Tree Viewer</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" />
  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>

  <style>
    /*
     * Palette derived from DEFAULT_THEME in treerenderer.js:
     *   bg           #02292E  deep dark teal
     *   branch/text  #F2F1E6  warm off-white
     *   tip          #BF4B43  muted coral-red
     *   internal     #19A699  teal accent
     *   label        #F7EECA  warm cream
     *   dimLabel     #E6D595  muted gold
     */
    :root {
      --pt-bg:       #02292E;
      --pt-bg-dark:  #021E22;
      --pt-border:   #05494F;
      --pt-red:      #BF4B43;
      --pt-teal:     #19A699;
      --pt-cream:    #F7EECA;
      --pt-gold:     #E6D595;
      --pt-off-white:#F2F1E6;
      --pt-btn-bg:   #033A42;
      --pt-btn-bdr:  #066878;
      --pt-btn-hover:#04545E;
    }

    /* ── Layout ── */
    html, body { height: 100%; overflow: hidden; }
    body {
      display: flex;
      flex-direction: column;
      background: var(--pt-bg);
      color: var(--pt-off-white);
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-size: 13px;
    }

    /* ── Navbar overrides ── */
    .pt-menubar {
      background: var(--pt-bg-dark);
      border-bottom: 1px solid var(--pt-border);
      min-height: 28px;
      padding: 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      user-select: none;
    }
    .pt-menubar .navbar-brand {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--pt-red) !important;
      letter-spacing: 0.4px;
      padding: 0 0.75rem 0 0;
      margin: 0;
      line-height: 28px;
    }
    /* Menu items (dropdown triggers) */
    .pt-menu-item {
      position: relative;
    }
    .pt-menu-item > .pt-menu-trigger {
      background: none;
      border: none;
      color: var(--pt-off-white);
      font-family: inherit;
      font-size: 0.7rem;
      padding: 0 0.6rem;
      line-height: 28px;
      cursor: pointer;
      border-radius: 3px;
      opacity: 0.85;
    }
    .pt-menu-item > .pt-menu-trigger:hover,
    .pt-menu-item > .pt-menu-trigger.open {
      background: rgba(255,255,255,0.08);
      opacity: 1;
    }
    /* Dropdown panel */
    .pt-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 160px;
      background: var(--pt-bg-dark);
      border: 1px solid var(--pt-border);
      border-radius: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 3px 0;
    }
    .pt-dropdown.open { display: block; }
    .pt-dropdown-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      color: var(--pt-off-white);
      font-family: inherit;
      font-size: 0.7rem;
      padding: 4px 14px 4px 12px;
      text-align: left;
      cursor: pointer;
      gap: 24px;
    }
    .pt-dropdown-item:hover { background: rgba(255,255,255,0.08); }
    .pt-dropdown-item.active { color: var(--pt-teal); }
    .pt-dropdown-item .shortcut {
      font-size: 0.63rem;
      opacity: 0.5;
    }
    .pt-dropdown-separator {
      height: 1px;
      background: var(--pt-border);
      margin: 3px 0;
    }
    #file-info {
      font-size: 0.63rem;
      color: var(--pt-gold);
      opacity: 0.65;
      margin-left: auto;
      padding-right: 0.25rem;
    }

    /* ── Toolbar ── */
    .pt-toolbar {
      background: var(--pt-bg-dark);
      border-bottom: 1px solid var(--pt-border);
      min-height: 36px;
      padding: 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    .pt-toolbar-sep {
      width: 1px;
      height: 18px;
      background: var(--pt-border);
      margin: 0 2px;
    }

    /* ── Sliders ── */
    .form-label-sm { font-size: 0.67rem; color: var(--pt-gold); margin-bottom: 0; }
    .form-range { width: 90px; accent-color: var(--pt-red); }

    /* ── Buttons ── */
    .btn-pt {
      background: var(--pt-btn-bg);
      color: var(--pt-off-white);
      border: 1px solid var(--pt-btn-bdr);
      font-family: inherit;
      font-size: 0.67rem;
      padding: 3px 10px;
      transition: background .15s;
    }
    .btn-pt:hover:not(:disabled) { background: var(--pt-btn-hover); color: var(--pt-off-white); }
    .btn-pt:disabled { opacity: 0.35; }
    .btn-pt.active  { background: var(--pt-red); border-color: var(--pt-red); color: var(--pt-cream); }

    /* ── Status bar ── */
    #status-bar {
      flex-shrink: 0;
      height: 24px;
      background: var(--pt-bg);
      border-top: 1px solid var(--pt-border);
    }
    #status-bar canvas { display: block; }

    /* ── Canvas area ── */
    #canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    canvas            { display: block; cursor: default; }
    canvas.space      { cursor: grab; }
    canvas.grabbing   { cursor: grabbing; }

    /* ── Loading overlay ── */
    #loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--pt-bg);
      gap: 14px;
    }
    #loading p { font-size: 0.72rem; color: var(--pt-gold); }
    .pt-spinner {
      width: 36px; height: 36px;
      border: 3px solid #044D59;
      border-top-color: var(--pt-red);
      border-radius: 50%;
      animation: pt-spin 0.8s linear infinite;
    }
    @keyframes pt-spin { to { transform: rotate(360deg); } }

    /* ── Error overlay ── */
    #error {
      display: none;
      position: absolute;
      inset: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--pt-bg);
      gap: 10px;
      color: var(--pt-red);
      font-size: 0.875rem;
      padding: 40px;
      text-align: center;
    }

    /* ── Help panel ── */
    #help-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 380px;
      background: var(--pt-bg-dark);
      border-left: 1px solid var(--pt-border);
      box-shadow: -4px 0 24px rgba(0,0,0,0.55);
      z-index: 600;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.22s cubic-bezier(.4,0,.2,1);
      overflow: hidden;
    }
    #help-panel.open { transform: translateX(0); }
    #help-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px 8px 16px;
      border-bottom: 1px solid var(--pt-border);
      flex-shrink: 0;
    }
    #help-panel-header h2 {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--pt-red);
      margin: 0;
      letter-spacing: 0.3px;
    }
    #btn-help-close {
      background: none;
      border: none;
      color: var(--pt-off-white);
      font-size: 1.1rem;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0.6;
      cursor: pointer;
    }
    #btn-help-close:hover { background: rgba(255,255,255,0.08); opacity: 1; }
    #help-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px 24px;
      font-size: 0.72rem;
      line-height: 1.65;
      color: var(--pt-off-white);
    }
    /* Markdown content styles */
    .help-md h1 { font-size: 0.82rem; font-weight: 700; color: var(--pt-cream); margin: 0 0 10px; }
    .help-md h2 { font-size: 0.72rem; font-weight: 700; color: var(--pt-teal); margin: 18px 0 6px; text-transform: uppercase; letter-spacing: 0.4px; }
    .help-md h3 { font-size: 0.7rem; font-weight: 600; color: var(--pt-gold); margin: 14px 0 4px; }
    .help-md p  { margin: 0 0 8px; }
    .help-md ul, .help-md ol { margin: 0 0 8px; padding-left: 18px; }
    .help-md li { margin-bottom: 3px; }
    .help-md code { background: rgba(255,255,255,0.07); border-radius: 3px; padding: 1px 4px; font-size: 0.67rem; color: var(--pt-cream); }
    .help-md pre  { background: rgba(0,0,0,0.25); border-radius: 4px; padding: 8px 10px; overflow-x: auto; }
    .help-md pre code { background: none; padding: 0; }
    .help-md strong { color: var(--pt-cream); }
    .help-md hr { border: none; border-top: 1px solid var(--pt-border); margin: 14px 0; }
    .help-md table { width: 100%; border-collapse: collapse; margin: 6px 0 10px; font-size: 0.67rem; }
    .help-md th { color: var(--pt-gold); font-weight: 600; text-align: left; padding: 4px 8px; border-bottom: 1px solid var(--pt-border); }
    .help-md td { padding: 3px 8px; border-bottom: 1px solid rgba(5,73,79,0.5); vertical-align: top; }
    .help-md tr:last-child td { border-bottom: none; }
    /* ? button in menubar */
    #btn-help {
      background: none;
      border: 1px solid var(--pt-btn-bdr);
      color: var(--pt-off-white);
      font-size: 0.67rem;
      line-height: 1;
      width: 20px;
      height: 20px;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0.7;
      margin-left: 8px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #btn-help:hover { background: rgba(255,255,255,0.08); opacity: 1; }
    #btn-help.active { background: var(--pt-red); border-color: var(--pt-red); opacity: 1; }

    /* ── Tooltip ── */
    #tooltip {
      position: absolute;
      background: rgba(3,58,66,0.97);
      border: 1px solid var(--pt-btn-bdr);
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 0.63rem;
      color: var(--pt-off-white);
      pointer-events: none;
      display: none;
      max-width: 320px;
      word-break: break-all;
      z-index: 10;
      line-height: 1.6;
    }
  </style>
</head>
<body>

<div class="pt-menubar">
  <span class="navbar-brand">PearTree</span>

  <!-- Node order menu -->
  <div class="pt-menu-item" id="menu-node-order">
    <button class="pt-menu-trigger" id="menu-node-order-trigger">Node order</button>
    <div class="pt-dropdown" id="menu-node-order-panel">
      <button class="pt-dropdown-item" id="btn-order-asc"  title="Order branches descending by tip count (⌘D)">
        Up <span class="shortcut">⌘D</span>
      </button>
      <button class="pt-dropdown-item" id="btn-order-desc" title="Order branches ascending by tip count (⌘U)">
        Down <span class="shortcut">⌘U</span>
      </button>
    </div>
  </div>

  <span id="file-info">Loading…</span>
  <button id="btn-help" title="Help">?</button>
</div>

<div class="pt-toolbar">
  <button id="btn-back"       class="btn btn-pt" disabled title="Navigate back (⌘[)">&#8249;</button>
  <button id="btn-forward"    class="btn btn-pt" disabled title="Navigate forward (⌘])">&#8250;</button>
  <div class="pt-toolbar-sep"></div>
  <button id="btn-fit"        class="btn btn-pt" title="Fit all (⌘0)">Fit all</button>
  <button id="btn-fit-labels" class="btn btn-pt" title="Fit labels (⌘⌥0)">Fit labels</button>
  <div class="pt-toolbar-sep"></div>
  <button id="btn-reroot" class="btn btn-pt" disabled title="Reroot tree at branch selection">Reroot</button>
  <div class="pt-toolbar-sep"></div>
  <span class="form-label-sm" style="padding: 0 2px 0 4px;">Select:</span>
  <div class="btn-group" role="group">
    <button id="btn-mode-nodes"    class="btn btn-pt active" style="border-radius: 3px 0 0 3px; border-right-width: 0;" title="Select nodes mode (⌘N)">Nodes</button>
    <button id="btn-mode-branches" class="btn btn-pt"        style="border-radius: 0 3px 3px 0;" title="Select branches mode (⌘B)">Branches</button>
  </div>
  <div class="pt-toolbar-sep"></div>
  <label class="d-flex align-items-center gap-1">
    <span class="form-label-sm">Label</span>
    <input type="range" class="form-range" id="font-size-slider" min="6" max="20" value="11" />
  </label>
  <label class="d-flex align-items-center gap-1">
    <span class="form-label-sm">Node</span>
    <input type="range" class="form-range" id="tip-size-slider" min="1" max="12" value="3" />
  </label>
</div>

<div id="canvas-container">
  <div id="loading"><div class="pt-spinner"></div><p id="loading-msg">Fetching tree file…</p></div>
  <div id="error"></div>
  <canvas id="tree-canvas"></canvas>
  <div id="tooltip"></div>
</div>

<div id="status-bar">
  <canvas id="status-canvas"></canvas>
</div>

<!-- Help panel -->
<div id="help-panel">
  <div id="help-panel-header">
    <h2>PearTree Help</h2>
    <button id="btn-help-close" title="Close help">&times;</button>
  </div>
  <div id="help-panel-body">
    <div class="help-md" id="help-content"><p style="opacity:0.5">Loading…</p></div>
  </div>
</div>

<script>
  // Lightweight menu-bar dropdown toggle (no Bootstrap JS needed)
  document.querySelectorAll('.pt-menu-item').forEach(item => {
    const trigger = item.querySelector('.pt-menu-trigger');
    const panel   = item.querySelector('.pt-dropdown');
    trigger.addEventListener('click', e => {
      e.stopPropagation();
      const open = panel.classList.contains('open');
      // Close all panels
      document.querySelectorAll('.pt-dropdown').forEach(p => p.classList.remove('open'));
      document.querySelectorAll('.pt-menu-trigger').forEach(t => t.classList.remove('open'));
      if (!open) {
        panel.classList.add('open');
        trigger.classList.add('open');
      }
    });
    // Close when a menu item is chosen
    panel.querySelectorAll('.pt-dropdown-item').forEach(btn => {
      btn.addEventListener('click', () => {
        panel.classList.remove('open');
        trigger.classList.remove('open');
      });
    });
  });
  // Click outside closes all menus
  document.addEventListener('click', () => {
    document.querySelectorAll('.pt-dropdown').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.pt-menu-trigger').forEach(t => t.classList.remove('open'));
  });

  // Help panel
  const helpPanel   = document.getElementById('help-panel');
  const helpContent = document.getElementById('help-content');
  const btnHelp      = document.getElementById('btn-help');
  const btnHelpClose = document.getElementById('btn-help-close');
  let helpLoaded = false;

  async function openHelp() {
    if (!helpLoaded) {
      try {
        const r = await fetch('help.md');
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const md = await r.text();
        helpContent.innerHTML = marked.parse(md);
        helpLoaded = true;
      } catch (err) {
        helpContent.innerHTML = `<p style="color:var(--pt-red)">Could not load help.md: ${err.message}</p>`;
      }
    }
    helpPanel.classList.add('open');
    btnHelp.classList.add('active');
  }

  function closeHelp() {
    helpPanel.classList.remove('open');
    btnHelp.classList.remove('active');
  }

  btnHelp.addEventListener('click', e => {
    e.stopPropagation();
    helpPanel.classList.contains('open') ? closeHelp() : openHelp();
  });
  btnHelpClose.addEventListener('click', closeHelp);

  // Close help on Escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeHelp();
  });
</script>
<script type="module" src="js/peartree.js"></script>
</body>
</html>
